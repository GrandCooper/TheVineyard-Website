<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <title>RottenSwap Governance Proposals</title>
      <style>
        body {
          margin: 8px
        }
        a, p {
          font-family: Roboto Mono;
          display: block; 
          max-width: 600px; 
          margin: auto;
          padding: 8px;
        }
        a {
          color: black;
          text-decoration: none;
        }
        .center {
          text-align: center;
        }
        .bold {
          font-weight: 800
        }
        .answer {
          margin: 8px;
        }
        img, video {
          display: block; 
          max-width: 600px; 
          margin: auto;
        }
        @media (max-width: 600px) {
          img, video {
            max-width: 95vw; 
          }
        }
      </style>
  </head>
  <body>
    <script>
      (async () => {
        const apiUrl = `https://rotapi.xyz/governance`
        const proposalId = getProposalId()
        console.log({proposalId})

        spacer()

        if (proposalId) {
          await proposal(proposalId)
        }
        else {
          await allProposals()
        }

        footer()
        spacer()

        async function proposal(id) {
          const loading = document.createElement('p')
          loading.innerHTML = `Loading...`
          loading.className = 'center'
          document.body.appendChild(loading)

          let proposal
          try {
            const response = await fetch(`${apiUrl}/getProposal/${id}`)
            proposal = await response.json()
            console.log({proposal})
            loading.remove()
          }
          catch (e) {
            loading.innerHTML = `Error: ${e.message}`
            throw e
          }

          // header
          const headerMessage = document.createElement('p')
          headerMessage.innerHTML = `Proposal ID ${proposal.id}`
          headerMessage.className = 'center'
          document.body.appendChild(headerMessage)
          spacer()
          helpInfo(id)

          // title
          const title = document.createElement('p')
          title.innerHTML = `${proposal.id}. ${proposal.title}`
          title.className = 'bold'
          document.body.appendChild(title)

          // description
          const description = document.createElement('p')
          description.innerHTML = proposal.description
          document.body.appendChild(description)

          // answers
          for (const answer of proposal.answers) {
            console.log(answer)
          
            const title = document.createElement('p')
            title.innerHTML = `${answer.id}. ${answer.title} (${answer.voteRotCount.split('.')[0]} ROT / ${answer.voteCount} votes)`
            title.className = 'bold'
            document.body.appendChild(title)
          }

          // votes
          spacer()
          const voteTitle = document.createElement('p')
          voteTitle.innerHTML = 'Votes'
          headerMessage.className = 'center'
          document.body.appendChild(voteTitle)
          for (const vote of proposal.votes) {
            console.log(vote)
          
            const voteElement = document.createElement('p')
            let answerTitle = proposal.answers[vote.answerId].title
            if (answerTitle.length > 30) {
              answerTitle = answerTitle.substring(0, 30) + '...'
            }
            voteElement.innerHTML = `${formatEthAddress(vote.ethAddress)} (${vote.rotBalanceAll.split('.')[0]} ROT): ${answerTitle}`
            document.body.appendChild(voteElement)
          }

          spacer()
          // back button
          const backButton = document.createElement('a')
          backButton.href = window.location.href.split('?')[0]
          backButton.innerHTML = 'All proposals'
          backButton.className = 'center'
          document.body.appendChild(backButton)
        }

        async function allProposals() {
          const loading = document.createElement('p')
          loading.innerHTML = `Loading...`
          loading.className = 'center'
          document.body.appendChild(loading)

          let proposals
          try {
            const response = await fetch(`${apiUrl}/getProposals`)
            proposals = await response.json()
            proposals = proposals.filter(proposal => proposal.status !== 'hidden')
            console.log({proposals})
            loading.remove()
          }
          catch (e) {
            loading.innerHTML = `Error: ${e.message}`
            throw e
          }

          proposals.reverse()

          // header
          const headerMessage = document.createElement('p')
          headerMessage.innerHTML = `Proposals`
          headerMessage.className = 'center'
          document.body.appendChild(headerMessage)
          spacer()
          helpInfo()

          // proposals
          for (const proposal of proposals) {          
            const title = document.createElement('a')
            title.href = `?id=${proposal.id}`
            const voteRotCount = proposal.voteRotCount ? proposal.voteRotCount.toFixed(0) : 0
            title.innerHTML = `${proposal.id}. ${proposal.title} (${voteRotCount} ROT / ${proposal.voteCount} votes)`
            title.className = 'bold'
            document.body.appendChild(title)

            const description = document.createElement('p')
            description.innerHTML = proposal.description
            document.body.appendChild(description)

            spacer()
          }
        }

        function spacer() {
          const space = document.createElement('p')
          space.innerHTML = ''
          document.body.appendChild(space)
        }

        function helpInfo(proposalId) {
          const helpInfo = document.createElement('p')
          const proposalIdText = proposalId || `"proposalId"`
          helpInfo.innerHTML = `Note: Use command /add_vote in <a target="_blank" style="display:inline; padding: 0" href="https://t.me/rottengovernance">t.me/rottengovernance</a>`
          document.body.appendChild(helpInfo)
        }

        function footer () {
          const footerMessage = document.createElement('p')
          footerMessage.innerHTML = `This page sucks. DM @timtemplet on Telegram if you're interested in designing a better one.`
          footerMessage.className = 'center'
          document.body.appendChild(footerMessage)
        }

        function formatEthAddress (ethAddress) {
          const parts = ethAddress.match(/......./g)
          console.log(parts, ethAddress)
          return `<a style="display:inline; padding: 0" target="_blank" href="https://etherscan.io/address/${ethAddress}">${parts[0]}...${parts[parts.length - 1]}</a>`
        }

        function getProposalId () {
          try {
            return window.location.search.match(/id=[^&#]+/)[0].replace('id=', '')
          }
          catch (e) {}
        }
      })()
    </script>
  <body>
</html>
